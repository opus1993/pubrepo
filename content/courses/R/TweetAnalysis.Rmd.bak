---
title: "#CaseIH Twitter Activity"
author: Jim Gruman
date: 1/25/2020
output: 
  html_document:
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
library(lubridate)
library(tidyverse)
library(rtweet)
library(keyring)
theme_set(theme_light())

# for use within the CNH network
library(httr)
set_config(use_proxy(url="http://proxyna.cnhind.com/proxycnhna.pac"))

```

![](https://www.caseih.com/PublishingImages/layout/caseih-logo.png)

```{r eval=FALSE, include=FALSE}
create_token(
  app = "IAPfeed",
  consumer_key = key_get("twitter.consumer_key", username = "jim_gruman"),
  consumer_secret = key_get("twitter.consumer_secret", username = "jim_gruman"),
  access_token = key_get("twitter.access_token", username = "jim_gruman"),
  access_secret = key_get("twitter.access_secret", username = "jim_gruman"))


<<<<<<< HEAD
case_ih_timeline <- get_timeline("case_ih", n=3200)
=======
case_ih_timeline <- get_timeline("case_ih", n=3200) %>%
    mutate(week = as.Date(floor_date(created_at, "week", week_start = 1)))

write_rds(case_ih_timeline, "./ciht.rds")
>>>>>>> f28a8ada7e7b2a503a3b9fe945cd17ceea802659

Sys.time()
```

```{r}
case_ih_timeline<-read_rds("./ciht.rds")

case_ih_timeline %>%
   mutate(hour=hour(with_tz(created_at, tz="America/Chicago")))  %>%
   group_by(hour) %>%
   summarize(n=n()) %>%
   mutate(frequency=n/sum(n)) %>%
   ggplot()+
   geom_col(aes(x=hour, y=frequency), 
             fill='red', alpha=0.5)+
   labs(title = "@CaseIH Tweet Activity by Time of Day",
     x = "Hour, CST", y = "Frequency",
     caption = str_c("Jim Gruman, ", Sys.Date()))

week_summary<- case_ih_timeline %>%
  group_by(week) %>%
  summarize(tweets = n(),
            avg_retweets =  exp(mean(log(retweet_count + 1))) -1)

week_summary %>%
  ggplot(aes(week, tweets))+
  geom_line()+
  expand_limits(y = 0)+
  labs(title = "@Case_IH Tweet Activity by Week",x = "Date",
       y = "@Case_IH Tweets",
       caption = str_c("Jim Gruman, ", Sys.Date()))

week_summary %>%
  ggplot(aes(week, avg_retweets))+
  geom_line()+
  expand_limits(y = 0)+
  labs(title = "@Case_IH Tweet Popularity by Week",x = "Date",
       y = "@Case_IH Average (Geometric Mean) Retweets",
       caption = str_c("Jim Gruman, ", Sys.Date()))
```

Which tweets get the most retweets, and thus the widest audience?

```{r eval=FALSE, include=FALSE}
case_ih_timeline%>%
  select(screen_name, retweet_screen_name, retweet_count, status_id)%>%
  arrange(desc(retweet_count))

case_ih_timeline%>%
  select(retweet_screen_name, retweet_count, favorite_count, status_id)%>%
  mutate(ratio = (favorite_count + 1) / (retweet_count + 1)) %>%
  arrange(ratio)

```


```{r eval=FALSE, include=FALSE}
# A look at the Twitter Screen Names of the most active users of the #CaseIH hashtags

case_ih_timeline %>%
  count(screen_name, sort = TRUE) %>%
  head(12) %>%
  mutate(screen_name = reorder(screen_name, n)) %>%
  ggplot(aes(screen_name, n))+
  geom_col() +
  coord_flip()
    
```

```{r}
library(tidytext)
tweet_words<-case_ih_timeline %>%
  select(screen_name, text, retweet_count, favorite_count, created_at, week, status_id) %>%
  unnest_tokens(word, text, token = "tweets") %>%
  anti_join(stop_words, by = "word") %>%
  filter(!word %in% c("#caseih", "@caseih", "37pm", "youll"),
         str_detect(word, "[a-z]"),
         !str_detect(word, "http")) 

tweet_words %>%
  count(word, sort = TRUE)%>%
  head(16)%>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n))+
  geom_col() +
  coord_flip() +
  labs(title = "Most Common Words in @CaseIH Tweets",
       y = "Frequency of Words")
    
```

```{r}
word_summary<-tweet_words %>%
  group_by(word)%>%
  summarize(n = n(),
            avg_retweets =   exp(mean(log(retweet_count + 1))) -1,
            avg_favorites = exp(mean(log(favorite_count+ 1)))-1) %>%
  filter(n >= 30) %>%
  arrange(desc(avg_retweets))

word_summary

```

# What topics are each week most about?

```{r}
library(tidytext)
top_word<-tweet_words %>%
  count(word, week) %>%
  bind_tf_idf(word, week, n) %>%
  filter(n>=2)%>%
  arrange(desc(tf_idf)) %>%
  distinct(week, .keep_all = TRUE)

week_summary %>%
  inner_join(top_word, by = c("week")) %>%
  arrange(desc(avg_retweets))
```


```{r}
week_summary %>%
  inner_join(top_word, by = c("week")) %>%
  ggplot(aes(week, tweets))+
  geom_line(color = "lightblue", size = 1)+
  geom_text(aes(label = word), check_overlap = TRUE,
            vjust = 1,
            hjust = 1) +
  expand_limits(y = 0)+
  labs(title = "@Case_IH's Tweets and Topics by Week",x = "Date",
       y = "@Case_IH Tweets", subtitle = "Word is each week's most specific by TF-IDF",
       caption = str_c("Jim Gruman, ", Sys.Date()))


week_summary %>%
  inner_join(top_word, by = c("week")) %>%
  ggplot(aes(week, avg_retweets))+
  geom_line(color = "lightblue", size = 1)+
  geom_text(aes(label = word), check_overlap = TRUE,
            vjust = 1,
            hjust = 1) +
  expand_limits(y = 0)+
  labs(title = "@Case_IH Twitter Popularity and Topics by Week",x = "Date",
       y = "@Case_IH Retweets",subtitle = "Word is each week's most specific by TF-IDF",
       caption = str_c("Jim Gruman, ", Sys.Date()))

```

----

The [rtweet package](https://rtweet.info) calls the Twitter API for the most recent tweet activity by @case_ih, including 3200 @Case_IH authored tweets, re-tweets of other authors, and favorites.

<img src="https://rtweet.info/reference/figures/logo.png" width="200">

[Dave Robinson R tutorial](https://www.youtube.com/watch?v=KE9ItC3doEU&t=80s)

